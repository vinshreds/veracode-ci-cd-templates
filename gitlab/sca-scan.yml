# ============================================================================
# Veracode SCA Scan (Software Composition Analysis) - GitLab CI Template
# ============================================================================
# This template demonstrates how to integrate Veracode SCA scanning into your
# GitLab CI/CD pipeline to identify vulnerabilities in third-party dependencies
# and open-source components.
#
# SCA Scan analyzes:
# - Third-party libraries and dependencies
# - Known vulnerabilities (CVEs)
# - License compliance and risks
# - Outdated components
# - Transitive dependencies
#
# SCA runs quickly (minutes) and can run in parallel with other scans.
#
# Prerequisites:
# - Veracode SCA Agent credentials in GitLab CI/CD variables (SRCCLR_API_TOKEN)
# - Dependency manifest files (pom.xml, package.json, requirements.txt, etc.)
# - Source code with dependency declarations
#
# Usage: Copy relevant jobs into your .gitlab-ci.yml file
#
# Documentation: https://docs.veracode.com/r/Agent_Based_Scans
# ============================================================================

# ============================================================================
# PIPELINE CONFIGURATION
# ============================================================================

stages:
  - security
  - report

# ============================================================================
# VARIABLES
# ============================================================================
# SRCCLR_API_TOKEN Setup Instructions:
#
# 1. Obtain Your SCA Agent Token:
#    - Log into Veracode Platform (https://analysiscenter.veracode.com/)
#    - Navigate to: Scans & Analysis â†’ Software Composition Analysis
#    - Select: Agent-Based Scan
#    - Select a Workspace (or create one)
#    - Select: Agents â†’ Actions â†’ Create
#    - Select any Integration Option
#    - Click: Create Agent & Generate Token
#    - COPY THE TOKEN IMMEDIATELY - it only displays once!
#
# 2. Store Token in GitLab:
#    - Go to: Settings â†’ CI/CD â†’ Variables â†’ Expand
#    - Click: Add variable
#    - Key: SRCCLR_API_TOKEN
#    - Value: (paste token from step 1)
#    - Type: Variable
#    - Flags: âœ“ Protected, âœ“ Masked
#    - Click: Add variable
#
# 3. Required Permissions:
#    - Organization agent: Security Lead role
#    - Workspace agent: Security Lead, Workspace Admin, Workspace Editor, or Submitter
#
# 4. Alternative - Group-Level Variables:
#    - For multiple projects: Group Settings â†’ CI/CD â†’ Variables
#    - All projects in group will inherit the variable
#
# 5. Regional Configuration (if applicable):
#    - European Region: Add SRCCLR_REGION variable with value: ER
#    - US Federal Region: Add SRCCLR_REGION variable with value: FED
#
# Documentation: https://docs.veracode.com/r/Manage_agents_and_scans
# ============================================================================

variables:
  APP_NAME: "my-application"
  FAIL_ON_VULNERABILITY: "true"
  # Regional configuration (uncomment if needed)
  # SRCCLR_REGION: "ER"  # For European region (or "FED" for US Federal)

# ============================================================================
# SCA SCAN JOB
# ============================================================================

veracode:sca-scan:
  stage: security
  image: alpine:latest

  # ========================================================================
  # SETUP BLOCK
  # ========================================================================

  before_script:
    - apk add --no-cache curl bash

    # Download Veracode SCA Agent
    - echo "Downloading Veracode SCA Agent..."
    - curl -sSL https://download.sourceclear.com/ci.sh -o ci.sh
    - chmod +x ci.sh

  # ========================================================================
  # SCAN BLOCK
  # ========================================================================

  script:
    - echo "Starting Veracode SCA scan for $APP_NAME..."

    # Run SCA scan
    - |
      ./ci.sh scan \
        --app "$APP_NAME" \
        --allow-dirty \
        --json > sca-results.json

    - echo "âœ“ SCA scan completed"

  # ========================================================================
  # ARTIFACTS
  # ========================================================================

  artifacts:
    name: "sca-results-$CI_COMMIT_SHORT_SHA"
    when: always
    paths:
      - sca-results.json
    reports:
      # GitLab can display dependency_scanning reports
      dependency_scanning: sca-results.json
    expire_in: 30 days

  # Allow job to fail without failing pipeline (optional)
  allow_failure: false

  only:
    - main
    - develop
    - merge_requests

# ============================================================================
# LANGUAGE-SPECIFIC SCANS
# ============================================================================

# ============================================================================
# Java/Maven Project
# ============================================================================

# veracode:sca-maven:
#   stage: security
#   image: maven:3.9-eclipse-temurin-11
#
#   before_script:
#     - apt-get update && apt-get install -y curl
#     - curl -sSL https://download.sourceclear.com/ci.sh -o ci.sh
#     - chmod +x ci.sh
#
#   script:
#     - echo "Resolving Maven dependencies..."
#     - mvn dependency:resolve
#
#     - echo "Running SCA scan..."
#     - ./ci.sh scan --app "$APP_NAME" --maven
#
#   only:
#     - main
#     - develop
#     - merge_requests

# ============================================================================
# Node.js/npm Project
# ============================================================================

# veracode:sca-npm:
#   stage: security
#   image: node:18-alpine
#
#   before_script:
#     - apk add --no-cache curl bash
#     - curl -sSL https://download.sourceclear.com/ci.sh -o ci.sh
#     - chmod +x ci.sh
#
#   script:
#     - echo "Installing npm dependencies..."
#     - npm ci
#
#     - echo "Running SCA scan..."
#     - ./ci.sh scan --app "$APP_NAME" --npm
#
#   cache:
#     key: "$CI_COMMIT_REF_SLUG"
#     paths:
#       - node_modules/
#
#   only:
#     - main
#     - develop
#     - merge_requests

# ============================================================================
# Python Project
# ============================================================================

# veracode:sca-python:
#   stage: security
#   image: python:3.11-alpine
#
#   before_script:
#     - apk add --no-cache curl bash
#     - curl -sSL https://download.sourceclear.com/ci.sh -o ci.sh
#     - chmod +x ci.sh
#
#   script:
#     - echo "Installing Python dependencies..."
#     - pip install -r requirements.txt
#
#     - echo "Running SCA scan..."
#     - ./ci.sh scan --app "$APP_NAME" --python
#
#   cache:
#     key: "$CI_COMMIT_REF_SLUG"
#     paths:
#       - .cache/pip
#
#   only:
#     - main
#     - develop
#     - merge_requests

# ============================================================================
# PARALLEL SCAN WITH BUILD
# ============================================================================

# Build and SCA in parallel for faster pipelines
# ============================================================================

# veracode:build-and-sca:
#   stage: security
#
#   parallel:
#     matrix:
#       - JOB_TYPE: build
#       - JOB_TYPE: sca
#
#   image: maven:3.9-eclipse-temurin-11
#
#   script:
#     - |
#       if [ "$JOB_TYPE" == "build" ]; then
#         echo "Building application..."
#         mvn clean package -DskipTests
#       else
#         echo "Running SCA scan..."
#         curl -sSL https://download.sourceclear.com/ci.sh -o ci.sh
#         chmod +x ci.sh
#         ./ci.sh scan --app "$APP_NAME"
#       fi
#
#   artifacts:
#     paths:
#       - target/
#     when: on_success
#     expire_in: 1 hour

# ============================================================================
# SCA WITH VULNERABILITY THRESHOLD
# ============================================================================

# veracode:sca-with-threshold:
#   stage: security
#   image: alpine:latest
#
#   before_script:
#     - apk add --no-cache curl bash
#     - curl -sSL https://download.sourceclear.com/ci.sh -o ci.sh
#     - chmod +x ci.sh
#
#   script:
#     - echo "Running SCA with vulnerability threshold..."
#
#     # Fail on CVSS >= 7.0 or high severity
#     - |
#       ./ci.sh scan \
#         --app "$APP_NAME" \
#         --threshold-cvss 7.0 \
#         --threshold-cve-severity high \
#         --json > sca-results.json
#
#   artifacts:
#     paths:
#       - sca-results.json
#     when: always
#     expire_in: 30 days
#
#   only:
#     - main
#     - /^release\/.*$/

# ============================================================================
# SBOM GENERATION
# ============================================================================

# veracode:generate-sbom:
#   stage: security
#   image: alpine:latest
#
#   before_script:
#     - apk add --no-cache curl bash
#     - curl -sSL https://download.sourceclear.com/ci.sh -o ci.sh
#     - chmod +x ci.sh
#
#   script:
#     - echo "Generating Software Bill of Materials..."
#
#     # Run scan
#     - ./ci.sh scan --app "$APP_NAME" --json > sca-results.json
#
#     # Generate SBOM
#     - |
#       ./ci.sh sbom \
#         --format cyclonedx \
#         --output sbom.json
#
#   artifacts:
#     name: "sbom-$CI_COMMIT_SHORT_SHA"
#     paths:
#       - sbom.json
#       - sca-results.json
#     expire_in: 90 days
#
#   only:
#     - tags
#     - main

# ============================================================================
# MONOREPO / MULTI-PROJECT SCAN
# ============================================================================

# veracode:monorepo-sca:
#   stage: security
#
#   parallel:
#     matrix:
#       - PROJECT: frontend
#         PATH: ./frontend
#         TYPE: npm
#       - PROJECT: backend
#         PATH: ./backend
#         TYPE: maven
#       - PROJECT: api
#         PATH: ./api
#         TYPE: python
#
#   image: alpine:latest
#
#   before_script:
#     - apk add --no-cache curl bash
#     - curl -sSL https://download.sourceclear.com/ci.sh -o ci.sh
#     - chmod +x ci.sh
#
#   script:
#     - cd $PATH
#     - echo "Scanning $PROJECT with $TYPE..."
#     - ../ci.sh scan --app "$APP_NAME-$PROJECT" --$TYPE
#
#   only:
#     - main
#     - develop

# ============================================================================
# LICENSE COMPLIANCE CHECK
# ============================================================================

# veracode:license-check:
#   stage: report
#   image: alpine:latest
#
#   needs:
#     - veracode:sca-scan
#
#   before_script:
#     - apk add --no-cache jq
#
#   script:
#     - echo "Checking license compliance..."
#
#     # Define prohibited licenses
#     - PROHIBITED_LICENSES="GPL AGPL LGPL"
#
#     # Parse SCA results for licenses
#     - |
#       for license in $PROHIBITED_LICENSES; do
#         if grep -qi "$license" sca-results.json; then
#           echo "âŒ Prohibited license found: $license"
#           exit 1
#         fi
#       done
#
#     - echo "âœ“ All licenses compliant"
#
#   only:
#     - main
#     - merge_requests

# ============================================================================
# MERGE REQUEST COMMENT
# ============================================================================

# veracode:mr-comment:
#   stage: report
#   image: alpine:latest
#
#   needs:
#     - veracode:sca-scan
#
#   before_script:
#     - apk add --no-cache curl jq
#
#   script:
#     - echo "Posting SCA results to merge request..."
#
#     # Parse results
#     - VULN_COUNT=$(jq '.vulnerabilities | length' sca-results.json || echo "0")
#     - CRITICAL=$(jq '[.vulnerabilities[] | select(.severity=="critical")] | length' sca-results.json || echo "0")
#     - HIGH=$(jq '[.vulnerabilities[] | select(.severity=="high")] | length' sca-results.json || echo "0")
#
#     # Create comment
#     - |
#       COMMENT="## Veracode SCA Scan Results\n\n"
#       COMMENT="${COMMENT}**Total Vulnerabilities**: ${VULN_COUNT}\n"
#       COMMENT="${COMMENT}- ðŸ”´ Critical: ${CRITICAL}\n"
#       COMMENT="${COMMENT}- ðŸŸ  High: ${HIGH}\n\n"
#
#       if [ "$VULN_COUNT" -gt 0 ]; then
#         COMMENT="${COMMENT}âš ï¸ Review dependencies before merging\n"
#       else
#         COMMENT="${COMMENT}âœ… No vulnerabilities found\n"
#       fi
#
#       COMMENT="${COMMENT}\n[View in Veracode Platform](https://sca.veracode.com)"
#
#     # Post to MR
#     - |
#       curl --request POST \
#         --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
#         --data "body=$COMMENT" \
#         "$CI_API_V4_URL/projects/$CI_PROJECT_ID/merge_requests/$CI_MERGE_REQUEST_IID/notes"
#
#   only:
#     - merge_requests

# ============================================================================
# SCHEDULED DEPENDENCY AUDIT
# ============================================================================

# veracode:weekly-audit:
#   stage: security
#   image: alpine:latest
#
#   before_script:
#     - apk add --no-cache curl bash
#     - curl -sSL https://download.sourceclear.com/ci.sh -o ci.sh
#     - chmod +x ci.sh
#
#   script:
#     - echo "Running scheduled dependency audit..."
#     - ./ci.sh scan --app "$APP_NAME" --json > sca-results.json
#
#   artifacts:
#     paths:
#       - sca-results.json
#     when: always
#     expire_in: 7 days
#
#   only:
#     - schedules
#
#   # Configure schedule in GitLab: CI/CD â†’ Schedules â†’ New schedule

# ============================================================================
# CONFIGURATION OPTIONS
# ============================================================================
#
# SCA Agent Parameters:
# --app: Application name in Veracode Platform
# --allow-dirty: Allow uncommitted changes
# --maven: Scan Maven projects
# --gradle: Scan Gradle projects
# --npm: Scan npm projects
# --yarn: Scan Yarn projects
# --pip: Scan Python pip projects
# --go: Scan Go modules
# --ruby: Scan Ruby gems
# --nuget: Scan .NET NuGet packages
# --threshold-cvss: Minimum CVSS score to fail (0.0-10.0)
# --threshold-cve-severity: Minimum severity (low, medium, high, critical)
# --json: Output results in JSON format
# --recursive: Scan subdirectories
# --no-upload: Don't upload results to platform
# --quick: Quick scan mode
#
# Environment Variables:
# - SRCCLR_API_TOKEN: SCA Agent API token (required)
# - SRCCLR_SCM_URI: Repository URL
# - SRCCLR_SCM_REF: Branch/tag name
# - SRCCLR_SCM_REV: Commit SHA
#
# Severity Levels:
# - Critical: CVSS 9.0-10.0
# - High: CVSS 7.0-8.9
# - Medium: CVSS 4.0-6.9
# - Low: CVSS 0.1-3.9
#
# Supported Package Managers:
# - Maven (pom.xml)
# - Gradle (build.gradle, build.gradle.kts)
# - npm (package.json, package-lock.json)
# - Yarn (yarn.lock)
# - pip (requirements.txt, Pipfile)
# - Poetry (poetry.lock)
# - Go (go.mod)
# - Ruby (Gemfile, Gemfile.lock)
# - NuGet (*.csproj, packages.config)
# - Composer (composer.json)
# - CocoaPods (Podfile, Podfile.lock)
#
# ============================================================================

# ============================================================================
# TROUBLESHOOTING
# ============================================================================
#
# Common Issues:
#
# 1. Token Authentication:
#    - Get token from Veracode Platform â†’ Agent-Based Scan
#    - Store as SRCCLR_API_TOKEN in GitLab CI/CD Variables
#    - Mark as "Masked" and "Protected"
#    - Verify token hasn't expired
#
# 2. No Dependencies Found:
#    - Ensure manifest files exist (pom.xml, package.json, etc.)
#    - Check you're in correct directory
#    - Use specific scan type flag (--maven, --npm, etc.)
#    - Run dependency install before scan
#
# 3. Build Failures:
#    - Set allow_failure: true to warn instead of fail
#    - Adjust CVSS or severity thresholds
#    - Review vulnerabilities in Veracode Platform
#
# 4. Image Compatibility:
#    - Some minimal images may need additional packages
#    - Install curl and bash if needed
#    - Use language-specific images when possible
#
# 5. Transitive Dependencies:
#    - Ensure lock files exist and are committed
#    - Run package manager install before scan
#    - Use --recursive for monorepos
#
# 6. Private Dependencies:
#    - Configure package manager authentication
#    - Set up .npmrc, settings.xml, etc.
#    - Store credentials in GitLab Variables
#
# 7. Cache Issues:
#    - Clear GitLab cache if dependencies not found
#    - Verify cache paths are correct
#    - Check cache key matches your workflow
#
# 8. Runner Permissions:
#    - Ensure runner has network access
#    - Check corporate firewall settings
#    - Verify download.sourceclear.com is accessible
#
# For more help:
# - Veracode: https://docs.veracode.com/r/Agent_Based_Scans
# - GitLab CI: https://docs.gitlab.com/ee/ci/
# ============================================================================
